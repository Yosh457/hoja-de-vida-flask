{# templates/_macros.html (VERSIÓN FINAL CORREGIDA) #}

{% macro render_pagination(pagination, endpoint, fragment='', extra_args={}) %}
    {# 1. Creamos un nuevo diccionario 'query_args' a partir de los argumentos extra. #}
    {% set query_args = extra_args.copy() %}
    {# 2. Actualizamos ese diccionario con los argumentos de la URL actual (ej: la búsqueda). #}
    {% do query_args.update(request.args) %}
    {# 3. Removemos el argumento 'page' para evitar duplicados, ya que lo pasaremos explícitamente. #}
    {% do query_args.pop('page', None) %}

<nav class="mt-6 flex items-center justify-between border-t border-gray-200 px-4 sm:px-0">
    <div class="flex w-0 flex-1">
        {% if pagination.has_prev %}
            <a href="{{ url_for(endpoint, page=pagination.prev_num, **query_args) }}{{ fragment }}" class="inline-flex items-center border-t-2 border-transparent pr-1 pt-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">
                &larr; Anterior
            </a>
        {% endif %}
    </div>
    
    <div class="hidden md:flex">
        {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if page_num %}
                <a href="{{ url_for(endpoint, page=page_num, **query_args) }}{{ fragment }}" class="inline-flex items-center border-t-2 px-4 pt-4 text-sm font-medium {% if pagination.page == page_num %} border-indigo-500 text-indigo-600 {% else %} border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 {% endif %}">
                    {{ page_num }}
                </a>
            {% else %}
                <span class="inline-flex items-center border-t-2 border-transparent px-4 pt-4 text-sm font-medium text-gray-500">...</span>
            {% endif %}
        {% endfor %}
    </div>

    <div class="flex w-0 flex-1 justify-end">
        {% if pagination.has_next %}
            <a href="{{ url_for(endpoint, page=pagination.next_num, **query_args) }}{{ fragment }}" class="inline-flex items-center border-t-2 border-transparent pl-1 pt-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">
                Siguiente &rarr;
            </a>
        {% endif %}
    </div>
</nav>
{% endmacro %}